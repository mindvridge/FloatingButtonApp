# 플로팅 버튼 앱 코드 구조 그래프

## 전체 아키텍처 개요

```
┌─────────────────────────────────────────────────────────────────┐
│                    플로팅 버튼 앱 아키텍처                        │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   MainActivity  │    │ FloatingButton  │    │ KeyboardDetection│
│   (메인 UI)      │    │ Service         │    │ Accessibility   │
│                 │    │ (핵심 서비스)    │    │ Service         │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   로그인 매니저들  │    │   OCR 분석      │    │   키보드 감지    │
│ • KakaoLogin    │    │ • ML Kit OCR    │    │ • 윈도우 상태    │
│ • GoogleLogin   │    │ • 텍스트 분석    │    │ • 키보드 높이    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   외부 서비스    │    │   AI API        │    │   화면 캡처     │
│ • 카카오 SDK    │    │ • Gemini API    │    │ • Accessibility │
│ • Firebase Auth │    │ • 답변 생성      │    │ • takeScreenshot│
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

## 상세 클래스 구조

### 1. 메인 액티비티 계층

```
MainActivity (ComponentActivity)
├── 로그인 상태 관리
│   ├── isLoggedIn: Boolean
│   └── currentUser: UserInfo?
├── 로그인 매니저들
│   ├── kakaoLoginManager: KakaoLoginManager
│   └── googleLoginManager: GoogleLoginManager
├── 권한 상태 관리
│   ├── hasOverlayPermission: Boolean
│   ├── hasAccessibilityPermission: Boolean
│   └── hasMediaProjectionPermission: Boolean
└── UI 컴포저블
    ├── MainScreen (로그인 후)
    ├── LoginScreen (로그인 전)
    └── FloatingButtonAppTheme
```

### 2. 서비스 계층

```
FloatingButtonService (LifecycleService)
├── UI 관리
│   ├── windowManager: WindowManager
│   ├── floatingView: View?
│   └── layoutParams: WindowManager.LayoutParams
├── 상태 관리
│   ├── isKeyboardVisible: Boolean
│   ├── lastButtonXPosition: Int
│   ├── lastButtonYPosition: Int
│   ├── screenHeight: Int
│   └── screenWidth: Int
├── OCR 관련
│   ├── textRecognizer: TextRecognizer
│   └── handler: Handler
├── 브로드캐스트 리시버들
│   ├── keyboardStateReceiver
│   ├── ocrRetryReceiver
│   └── screenshotReceiver
└── 분석 및 처리
    ├── analyzeOcrResult()
    ├── classifyTextType()
    ├── generateSmartSuggestions()
    └── showOcrBottomSheet()
```

### 3. 접근성 서비스 계층

```
KeyboardDetectionAccessibilityService (AccessibilityService)
├── 정적 변수들
│   ├── instance: KeyboardDetectionAccessibilityService?
│   ├── isKeyboardVisible: Boolean
│   └── keyboardHeight: Int
├── 상태 관리
│   ├── lastKeyboardState: Boolean
│   ├── screenBounds: Rect
│   └── screenHeight: Int
├── 키보드 감지
│   ├── checkKeyboardState()
│   ├── detectKeyboard()
│   └── broadcastKeyboardShown/Hidden()
└── 화면 캡처
    ├── takeScreenshot()
    ├── isScreenCaptureEnabled
    └── broadcastScreenshot()
```

### 4. 로그인 매니저 계층

```
KakaoLoginManager
├── SharedPreferences 관리
│   ├── isLoggedIn: Boolean
│   ├── userId: String?
│   ├── nickname: String?
│   ├── profileImageUrl: String?
│   └── email: String?
├── 카카오 SDK 연동
│   ├── initializeKakaoSdk()
│   ├── loginWithKakao()
│   └── logout()
└── 사용자 정보 관리
    ├── saveUserInfo()
    ├── clearUserInfo()
    └── getCurrentUser()

GoogleLoginManager
├── Firebase Auth 연동
│   ├── firebaseAuth: FirebaseAuth
│   ├── googleSignInClient: GoogleSignInClient
│   └── firebaseAuthWithGoogle()
├── SharedPreferences 관리
│   ├── isLoggedIn: Boolean
│   ├── userId: String?
│   ├── displayName: String?
│   ├── email: String?
│   └── photoUrl: String?
└── 사용자 정보 관리
    ├── saveUserInfo()
    ├── clearUserInfo()
    └── getCurrentUser()
```

### 5. API 계층

```
ApiClient (Singleton)
├── HTTP 클라이언트 설정
│   ├── loggingInterceptor
│   ├── headerInterceptor
│   └── okHttpClient
├── JSON 처리
│   └── gson
└── Retrofit 설정
    ├── retrofit
    └── apiService: ApiService

ApiService (Interface)
├── ReplyRequest (데이터 클래스)
│   ├── 대상자: String
│   ├── 답변길이: String
│   ├── 대화내용: String
│   ├── 추가지침: String
│   └── 모델: String
├── Answer (데이터 클래스)
│   ├── text: String?
│   ├── content: String?
│   ├── score: Double?
│   └── metadata: Map<String, Any>?
├── ReplyResponse (데이터 클래스)
│   ├── model: String?
│   ├── count: Int?
│   ├── answers: List<Answer>?
│   ├── message: String?
│   └── error: String?
└── getReplies(): Response<ReplyResponse>
```

### 6. UI 계층

```
OcrBottomSheetActivity (ComponentActivity)
├── OCR 결과 표시
├── 텍스트 편집 기능
├── 답변 추천 옵션
└── AI 답변 생성

TextEditActivity (ComponentActivity)
├── OCR 텍스트 수정
├── 이미지 표시
└── 편집 완료 처리

Theme 관련
├── Color.kt
├── Theme.kt
└── Type.kt
```

### 7. 데이터 클래스들

```
UserInfo
├── userId: String?
├── nickname: String?
├── profileImageUrl: String?
└── email: String?

LoginResult
├── isSuccess: Boolean
├── userId: String?
├── nickname: String?
├── profileImageUrl: String?
├── email: String?
└── errorMessage: String?

OcrAnalysis
├── originalText: String
├── textType: TextType
├── confidence: Float
├── language: String
├── suggestions: List<String>
├── keywords: List<String>
├── entities: List<TextEntity>
└── chatAnalysis: ChatAnalysis?

ChatAnalysis
├── sender: ChatSender
├── confidence: Float
├── position: ChatPosition
├── timeInfo: String?
├── messageType: MessageType
├── isGroupChat: Boolean
└── participants: List<String>

TextEntity
├── text: String
├── type: EntityType
├── startIndex: Int
└── endIndex: Int
```

## 데이터 흐름

### 1. 앱 시작 흐름
```
FloatingButtonApplication.onCreate()
    ↓
카카오 SDK 초기화
    ↓
MainActivity.onCreate()
    ↓
권한 확인 및 로그인 상태 확인
    ↓
UI 표시 (로그인 화면 또는 메인 화면)
```

### 2. 로그인 흐름
```
사용자가 로그인 버튼 클릭
    ↓
KakaoLoginManager.loginWithKakao() 또는 GoogleLoginManager.getSignInIntent()
    ↓
외부 서비스 (카카오/구글) 인증
    ↓
사용자 정보 저장 및 UI 업데이트
    ↓
메인 화면으로 전환
```

### 3. 플로팅 버튼 서비스 시작 흐름
```
사용자가 "서비스 시작" 버튼 클릭
    ↓
권한 확인 (오버레이, 접근성)
    ↓
FloatingButtonService 시작
    ↓
포그라운드 서비스로 등록
    ↓
키보드 상태 감지 시작
```

### 4. OCR 및 답변 생성 흐름
```
키보드 표시 감지
    ↓
플로팅 버튼 표시
    ↓
사용자가 플로팅 버튼 클릭
    ↓
화면 캡처 (AccessibilityService)
    ↓
ML Kit OCR 텍스트 인식
    ↓
텍스트 분석 및 분류
    ↓
AI API 호출 (답변 생성)
    ↓
OcrBottomSheetActivity로 결과 표시
    ↓
사용자가 답변 선택 및 사용
```

### 5. 키보드 감지 흐름
```
AccessibilityService.onAccessibilityEvent()
    ↓
윈도우 상태 변경 감지
    ↓
키보드 상태 분석 (IME 윈도우, 화면 영역)
    ↓
브로드캐스트 전송
    ↓
FloatingButtonService에서 수신
    ↓
플로팅 버튼 표시/숨김 처리
```

## 주요 특징

### 1. 모듈화된 설계
- 각 기능별로 독립적인 클래스로 분리
- 단일 책임 원칙 적용
- 의존성 주입 패턴 사용

### 2. 비동기 처리
- 코루틴을 사용한 비동기 작업
- suspend 함수를 통한 안전한 비동기 처리
- 콜백 기반의 외부 API 연동

### 3. 상태 관리
- Compose의 State를 활용한 반응형 UI
- SharedPreferences를 통한 영구 저장
- 브로드캐스트를 통한 컴포넌트 간 통신

### 4. 권한 관리
- 런타임 권한 요청
- 접근성 서비스 권한 활용
- 사용자 친화적인 권한 가이드

### 5. 에러 처리
- Result 타입을 통한 안전한 에러 처리
- 로깅을 통한 디버깅 지원
- 사용자에게 친화적인 에러 메시지

이 구조는 확장성과 유지보수성을 고려하여 설계되었으며, 각 컴포넌트가 명확한 역할과 책임을 가지고 있습니다.

